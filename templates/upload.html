<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Upload</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js" integrity="sha512-DdX/YwF5e41Ok+AI81HI8f5/5UsoxCVT9GKYZRIzpLxb8Twz4ZwPPX+jQMwMhNQ9b5+zDEefc+dcvQoPWGNZ3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='css/styles.css')}}">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        {% if session.get('user_id') %}
            <div class="logout">
                <a class="logout-button" href="{{ url_for('logout') }}" class="logout-button">Logout</a>
            </div>
        {% endif %}
        
        <h1>Batch Image Upload</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div>
                <label for="files">Choose images to upload</label>
                <input type="file" id="files" name="files[]" multiple accept=".png,.jpg,.jpeg">
            </div>
            <div>
                <label for="trigger_word">Trigger Word</label>
                <input type="text" id="trigger_word" name="trigger_word" required>
            </div>
            <div>
                <label for="steps">Training Steps</label>
                <input type="number" id="steps" name="steps" value="800" min="200" max="2000" required>
            </div>
            <div>
                <button type="submit" class="generate-button">Upload and Start Training</button>
            </div>
        </form>
        
        <div id="loadingState" class="hidden">
            <p id="progressText"></p>
            <div id="training-logs"></div>
            <button id="cancelButton" class="cancel-button hidden">Cancel Training</button>
        </div>
        
        <div>
            <a href="/generate" class="back-link">Back to Image Generator</a>
        </div>
        
        <div>
            <a href="/test-redis" target="_blank">Test Redis Connection</a>
        </div>
    </div>

    <script>
        let statusCheckInterval;
        let cancelUrl;

        function checkTrainingStatus(trainingId) {
            fetch(`/training_status/${trainingId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    updateUI(data);
                    
                    if (data.cancel_url) {
                        cancelUrl = data.cancel_url;
                        document.getElementById('cancelButton').classList.remove('hidden');
                    } else {
                        document.getElementById('cancelButton').classList.add('hidden');
                    }
                    
                    if (data.status === 'succeeded' || data.status === 'failed' || data.status === 'canceled') {
                        clearInterval(statusCheckInterval);
                        document.getElementById('uploadForm').style.display = 'block';
                        document.getElementById('loadingState').classList.add('hidden');
                        if (data.status === 'succeeded') {
                            window.location.href = '/generate';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking training status:', error);
                    updateUI({ status: 'Error checking training status. Please try again.' });
                });
        }

        function updateUI(data) {
            document.getElementById('progressText').textContent = `Status: ${data.status}`;
            document.getElementById('training-logs').textContent = `Elapsed Time: ${data.elapsed_time}`;
        }

        document.getElementById('cancelButton').addEventListener('click', function() {
            if (cancelUrl) {
                fetch(cancelUrl, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Training canceled:', data);
                        updateUI({ status: 'Canceling...' });
                    })
                    .catch(error => {
                        console.error('Error canceling training:', error);
                    });
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const formData = new FormData(form);
            
            document.getElementById('loadingState').classList.remove('hidden');
            form.style.display = 'none';
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (data.status !== 'canceled' || data.status !== 'failed') {
                    statusCheckInterval = setInterval(() => checkTrainingStatus(data.id), 20000);
                    checkTrainingStatus(data.id);
                }
                else if (data.status  === 'succeeded') {
                    clearInterval(statusCheckInterval);
                    window.location.href = '/generate';
                }
                else {
                    throw new Error(data.message || 'Unexpected response from server');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('progressText').textContent = `Error: ${error.message}`;
                document.getElementById('loadingState').classList.remove('hidden');
                form.style.display = 'block';
            });
        });
    </script>
</body>
</html>