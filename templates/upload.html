<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Upload</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/styles.css')}}">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        {% if session.get('user_id') %}
            <div class="logout">
                <a class="logout-button" href="{{ url_for('logout') }}" class="logout-button">Logout</a>
            </div>
        {% endif %}
        
        <h1>Batch Image Upload</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div>
                <label for="files">Choose images to upload</label>
                <input type="file" id="files" name="files[]" multiple accept=".png,.jpg,.jpeg">
            </div>
            <div>
                <label for="trigger_word">Trigger Word</label>
                <input type="text" id="trigger_word" name="trigger_word" required>
            </div>
            <div>
                <label for="steps">Training Steps</label>
                <input type="number" id="steps" name="steps" value="800" min="200" max="2000" required>
            </div>
            <div>
                <button type="submit" class="generate-button">Upload and Start Training</button>
            </div>
        </form>
        
        <div id="loadingState" class="hidden">
            <div>
               
                <p id="progressText"></p>
                <span id="training-logs"></span>
            </div>
            <div class="progress-bar">
                <div id="progressBar" style="width: 0%"></div>
            </div>
        </div>
        
        <div>
            <a href="/generate" class="back-link">Back to Image Generator</a>
        </div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const formData = new FormData(form);
            
            // Show loading state
            document.getElementById('loadingState').classList.remove('hidden');
            
            fetch(form.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'queued' || data.status === 'starting' || data.status === 'running' && data.training_id) {
                    checkTrainingStatus(data.training_id);
                } else {
                    document.getElementById('progressText').textContent =  (data.message + ' ' + data.statu|| 'Unknown');
                    document.getElementById('loadingState').classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('progressText').textContent = 'Error submitting form.';
                document.getElementById('loadingState').classList.add('hidden');
            });
        });

        function checkTrainingStatus(trainingId) {
            fetch(`/training_status/${trainingId}`)
            .then(response => response.json())
            .then(data => {
                const progressText = document.getElementById('progressText');
                const trainingLogs = document.getElementById('training-logs');
                if (data.error) {
                    progressText.textContent = 'Error: ' + data.error;
                    document.getElementById('loadingState').classList.add('hidden');
                    return;
                }
                
                progressText.textContent = `Status: ${data.status} | Elapsed Time: ${data.elapsed_time}`;
                trainingLogs.textContent = data.logs;
                
                if (data.status === 'succeeded') {
                    progressText.textContent = 'Training completed successfully!';
                    document.getElementById('loadingState').classList.add('hidden');
                } else if (data.status === 'failed' || data.status === 'canceled') {
                    progressText.textContent = `Training ${data.status}.`;
                    document.getElementById('loadingState').classList.add('hidden');
                } else {
                    // Continue checking status for in-progress training
                    setTimeout(() => checkTrainingStatus(trainingId), 10000); // Check every 10 seconds
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('progressText').textContent = 'Error checking training status.';
                document.getElementById('loadingState').classList.add('hidden');
            });
        }
    </script>
</body>
</html>