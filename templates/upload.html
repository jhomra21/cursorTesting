<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Upload</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"
        integrity="sha512-DdX/YwF5e41Ok+AI81HI8f5/5UsoxCVT9GKYZRIzpLxb8Twz4ZwPPX+jQMwMhNQ9b5+zDEefc+dcvQoPWGNZ3g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='css/styles.css')}}">
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container">
        {% if session.get('user_id') %}
        <div class="logout">
            <a class="logout-button" href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
        {% endif %}

        <h1>Batch Image Upload</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="message {{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form id="uploadForm" method="post" enctype="multipart/form-data">
            <div>
                <label for="files">Choose images to upload</label>
                <input type="file" id="files" name="files[]" multiple accept=".png,.jpg,.jpeg">
            </div>
            <div>
                <label for="trigger_word">Trigger Word</label>
                <input type="text" id="trigger_word" name="trigger_word" required>
            </div>
            <div>
                <label for="steps">Training Steps</label>
                <input type="number" id="steps" name="steps" value="800" min="200" max="2000" required>
            </div>
            <div>
                <button type="submit" class="generate-button">Upload and Start Training</button>
            </div>
        </form>

        <div id="loadingState" class="hidden">
            <p id="progressText"></p>
            <div id="training-logs"></div>
            <button id="cancelButton" class="cancel-button hidden">Cancel Training</button>
        </div>

        <div>
            <a href="/generate" class="back-link">Back to Image Generator</a>
        </div>

    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const form = this;
            const formData = new FormData(form);

            document.getElementById('loadingState').classList.remove('hidden');
            form.style.display = 'none';

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.task_id) {
                        checkTrainingStatus(data.task_id);
                    } else {
                        throw new Error('No task ID received');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingState').classList.add('hidden');
                    form.style.display = 'block';
                    alert('An error occurred while starting the training.');
                });
        });

        function checkTrainingStatus(taskId) {
            fetch(`/training_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('statusMessage');
                    if (statusElement) {
                        statusElement.textContent = data.status;
                    }
                    if (data.state === 'SUCCESS') {
                        document.getElementById('loadingState').classList.add('hidden');
                        alert('Training started successfully!');
                    } else if (data.state === 'FAILURE') {
                        document.getElementById('loadingState').classList.add('hidden');
                        alert('Training failed. Please try again.');
                    } else {
                        setTimeout(() => checkTrainingStatus(taskId), 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking training status:', error);
                });
        }
    </script>
</body>

</html>